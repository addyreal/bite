#!/bin/bash

DIR="$(dirname "${BASH_SOURCE[0]}")"
TESTFILE="bite_test.go"
[[ -w "$DIR" ]] || { echo "Error creating file $TESTFILE"; exit 1; }
[[ -e $TESTFILE ]] && { echo "Error creating file $TESTFILE"; exit 1; }
which go >/dev/null 2>&1 || { echo "Error invoking go"; exit 1; }
cd "$DIR" || exit
tee $TESTFILE >/dev/null <<'EOF'
package bite

import (
	"testing"
)

func TestBite(t *testing.T) {
	b := Init()

	____ := -1
	b.Add("__0",    )
	b.Add("__1",    0xfa, 0xd8, 0xff, 0xe0, 0x00, 0xee, 0x4a, 0x46, 0x49, 0x46, 0x00, 0x01)
	b.Add("__2",    0x89)
	b.Add("png",    0x89, 0x50, 0x4e, 0x47, 0x0d, 0x0a, 0x1a, 0x0a)
	b.Add("__3",    0x89, 0x50)
	b.Add("_ji",    0x90, ____, 0x91)
	b.Add("avi",    0x52, 0x49, 0x46, 0x46, ____, ____, ____, ____, 0x41, 0x56, 0x49, 0x20)
	b.Add("wav",    0x52, 0x49, 0x46, 0x46, ____, ____, ____, ____, 0x57, 0x41, 0x56, 0x45)
	b.Add("jpeg 1", 0xff, 0xd8, 0xff, 0xe0)
	b.Add("jpeg 2", 0xff, 0xd8, 0xff, 0xe0, 0x00, 0x10, 0x4a, 0x46, 0x49, 0x46, 0x00, 0x01)
	b.Add("__4",    0xff, 0xd8, 0xff, 0xe0, 0x00, 0xee, 0x4a, 0x46, 0x49, 0x46, 0x00, 0x01)
	//b.Add("thing",  ____, 0x00, 0xff, 0x30)

	table := b.Get()

	tests := []struct {
		name	string
		input   []byte
		res     string
	}{
		{"empty arg", []byte{}, ""},
		{"no match", []byte{0xf1, 0xf2, 0x12, 0x23, 0xea}, ""},
		{"easy exact match", []byte{0x89, 0x50, 0x4e, 0x47, 0x0d, 0x0a, 0x1a, 0x0a}, "png"},
		{"easy wildcard match", []byte{0x90, 0xea, 0x91, 0x11, 0x00, 0xff}, "_ji"},
		{"first ambiguous match", []byte{0x52, 0x49, 0x46, 0x46, 0x14, 0xe1, 0xc8, 0x00, 0x41, 0x56, 0x49, 0x20, 0x12}, "avi"},
		{"second ambiguous match", []byte{0x52, 0x49, 0x46, 0x46, 0x12, 0x00, 0xff, 0x00, 0x57, 0x41, 0x56, 0x45}, "wav"},
		{"first subset match", []byte{0xff, 0xd8, 0xff, 0xe0, 0x32, 0x1a, 0xef, 0x66, 0xa9, 0xf6, 0x11, 0xf1, 0xff}, "jpeg 1"},
		{"second subset match", []byte{0xff, 0xd8, 0xff, 0xe0, 0x00, 0x10, 0x4a, 0x46, 0x49, 0x46, 0x00, 0x01, 0xaa}, "jpeg 2"},
		//{"easy beginning wildcard match", []byte{0x33, 0x00, 0xff, 0x30}, "thing"},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			res, ok := table.Find(tt.input)
			if ok == true {
				if res.(string) != tt.res {
					t.Errorf(`%s: failed. Expected "%s", got "%s"`, tt.name, tt.res, res)
				}
			} else {
				if tt.res != "" {
					t.Errorf(`%s: failed. Expected "%s", got nothing`, tt.name, tt.res)
				}
			}

		})
	}
}
EOF
go test -v
rm $TESTFILE
